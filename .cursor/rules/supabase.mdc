---
description: Supabase client usage and database patterns
globs: ["lib/supabase/**/*.ts", "app/**/*.ts", "app/**/*.tsx", "actions/**/*.ts", "middleware.ts"]
---

# Supabase Rules

## Critical: Package Usage

**NEVER use deprecated packages:**

```typescript
// ❌ DEPRECATED - Do not use
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';

// ✅ CORRECT - Use @supabase/ssr
import { createBrowserClient, createServerClient } from '@supabase/ssr';
```

The `@supabase/auth-helpers-nextjs` package is deprecated. Always use `@supabase/ssr`.

## Client Creation

**Critical: Always create a fresh client per request - never store in global variables.**

### Server Components / Server Actions

```typescript
// lib/supabase/server.ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Called from Server Component - can be ignored if using middleware
          }
        },
      },
    }
  );
}
```

### Client Components

```typescript
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
  );
}
```

### Middleware (Session Refresh)

```typescript
// middleware.ts
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          supabaseResponse = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // Refresh session - IMPORTANT
  await supabase.auth.getUser();

  return supabaseResponse;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

## Authentication

- Use middleware to refresh sessions on every request
- Always use `getUser()` for auth checks (validates with Supabase Auth server)
- `getSession()` only reads from cookies (can be spoofed)

```typescript
// ✅ Correct - validates with server
const { data: { user }, error } = await supabase.auth.getUser();

// ⚠️ Use only for non-sensitive data
const { data: { session } } = await supabase.auth.getSession();
```

### Protected Routes Pattern

```typescript
// app/protected/page.tsx
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';

export default async function ProtectedPage() {
  const supabase = await createClient();
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user) {
    redirect('/auth/login');
  }

  return <div>Welcome, {user.email}</div>;
}
```

## Database Queries

- Always type queries with generated database types
- Use `.select()` to specify columns - don't fetch more than needed
- Handle errors from every query
- Use `.single()` when expecting one row

```typescript
// ✅ Typed, selective, error-handled query
const { data: post, error } = await supabase
  .from('posts')
  .select('id, title, created_at, author:users(name)')
  .eq('id', postId)
  .single();

if (error) {
  throw new Error(`Failed to fetch post: ${error.message}`);
}
```

## Row Level Security (RLS)

- NEVER bypass RLS in client code
- Design policies to be the source of truth for access control
- Test RLS policies in development
- Use `service_role` key ONLY in secure server contexts (webhooks, admin scripts)

```sql
-- Example RLS policy
CREATE POLICY "Users can read own posts"
ON posts FOR SELECT
TO authenticated
USING (auth.uid() = user_id);
```

## Realtime Subscriptions

- Only subscribe in Client Components
- Always clean up subscriptions in useEffect cleanup
- Use channels for presence and broadcast features

```typescript
'use client';

import { useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';

export function RealtimeComponent() {
  useEffect(() => {
    const supabase = createClient();

    const channel = supabase
      .channel('posts-changes')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'posts' },
        (payload) => console.log('Change:', payload)
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  return <div>Listening for changes...</div>;
}
```

## Type Safety

Generate and use database types:

```bash
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > lib/database.types.ts
```

```typescript
import { Database } from '@/lib/database.types';

type Post = Database['public']['Tables']['posts']['Row'];
type InsertPost = Database['public']['Tables']['posts']['Insert'];
type UpdatePost = Database['public']['Tables']['posts']['Update'];
```

## Common Mistakes

- Using deprecated `@supabase/auth-helpers-nextjs`
- Storing Supabase client in global variable
- Using `getSession()` for auth checks instead of `getUser()`
- Forgetting to refresh session in middleware
- Not handling query errors
- Exposing `service_role` key to client

---
description: Next.js App Router patterns, conventions, and anti-patterns
globs: ["app/**/*.ts", "app/**/*.tsx"]
---

# Next.js App Router Rules

## Component Model

### Server Components by Default

Only add `'use client'` when you need:
- Event handlers (onClick, onChange, etc.)
- React hooks (useState, useEffect, etc.)
- Browser-only APIs

```typescript
// ✅ Server Component - zero JS shipped (default)
export default async function ProductList() {
  const products = await getProducts();
  return <ul>{products.map(p => <li key={p.id}>{p.name}</li>)}</ul>;
}

// ✅ Only add 'use client' when necessary
'use client';
export function Counter() {
  const [count, setCount] = useState(0);
  return <button onClick={() => setCount(c => c + 1)}>{count}</button>;
}
```

### Push Client Boundaries Down

```typescript
// ❌ BAD: Entire page is client
'use client';
export default function Page() {
  const [tab, setTab] = useState('overview');
  return (
    <div>
      <Header />      {/* Unnecessarily client-side */}
      <DataTable />   {/* Unnecessarily client-side */}
      <TabSwitcher tab={tab} setTab={setTab} />
    </div>
  );
}

// ✅ GOOD: Only interactive part is client
export default function Page() {
  return (
    <div>
      <Header />      {/* Server Component */}
      <DataTable />   {/* Server Component */}
      <Suspense fallback={<Skeleton />}>
        <TabSwitcher />  {/* Only this ships JS */}
      </Suspense>
    </div>
  );
}
```

### Don't Pass Sensitive Data to Client

```typescript
// ❌ BAD: Passing full user record to client
'use client';
export function UserCard({ user }: { user: FullUserRecord }) {
  // user.passwordHash is now in the browser!
}

// ✅ GOOD: Only pass what client needs
'use client';
export function UserCard({ user }: { user: { name: string; avatar: string } }) {
  // Only safe, necessary data
}
```

## Data Fetching

### Fetch in Server Components

```typescript
// ❌ BAD: Client-side fetching
'use client';
export function Posts() {
  const [posts, setPosts] = useState([]);
  useEffect(() => {
    fetch('/api/posts').then(r => r.json()).then(setPosts);
  }, []);
  return <div>{posts.map(...)}</div>;
}

// ✅ GOOD: Server Component fetching
export default async function Posts() {
  const posts = await getPosts();
  return <div>{posts.map(...)}</div>;
}
```

### Parallel Fetching

```typescript
// ❌ BAD: Sequential (waterfall)
const user = await getUser();
const posts = await getPosts();

// ✅ GOOD: Parallel
const [user, posts] = await Promise.all([getUser(), getPosts()]);
```

### Streaming with Suspense

```typescript
// ✅ Show page immediately, stream slow content
export default function Page() {
  return (
    <div>
      <Header />  {/* Instant */}
      <Suspense fallback={<PostsSkeleton />}>
        <Posts />  {/* Streams when ready */}
      </Suspense>
    </div>
  );
}
```

## File Conventions

Colocate these files with your routes:

```
app/
  dashboard/
    page.tsx        # The route UI
    loading.tsx     # Loading state (Suspense boundary)
    error.tsx       # Error boundary
    not-found.tsx   # 404 for this route
    layout.tsx      # Shared layout (only if needed)
    actions.ts      # Server Actions for this route
```

## Server Actions

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';

const schema = z.object({
  title: z.string().min(1).max(100),
});

export async function createPost(formData: FormData) {
  // 1. Validate input
  const parsed = schema.safeParse({ title: formData.get('title') });
  if (!parsed.success) {
    return { success: false, error: parsed.error.flatten() };
  }

  // 2. Check auth
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return { success: false, error: 'Unauthorized' };
  }

  // 3. Execute mutation
  const { error } = await supabase.from('posts').insert({ 
    title: parsed.data.title,
    user_id: user.id 
  });

  if (error) {
    return { success: false, error: error.message };
  }

  // 4. Revalidate cache
  revalidatePath('/posts');
  return { success: true };
}
```

## Routing

### Use Route Groups

```typescript
// ❌ URLs affected by folder structure
app/auth/login/page.tsx      → /auth/login

// ✅ Route groups for clean URLs
app/(auth)/login/page.tsx    → /login
app/(dashboard)/home/page.tsx → /home
```

### Use Link, Not router.push

```typescript
// ❌ BAD: Programmatic navigation for simple links
'use client';
function NavItem({ href }) {
  const router = useRouter();
  return <button onClick={() => router.push(href)}>Go</button>;
}

// ✅ GOOD: Link component (prefetching, accessibility)
import Link from 'next/link';
function NavItem({ href }) {
  return <Link href={href}>Go</Link>;
}
```

## Images

```typescript
// ❌ BAD: Regular img tag
<img src="/hero.png" alt="Hero" />

// ✅ GOOD: Next.js Image (optimized, lazy-loaded)
import Image from 'next/image';
<Image 
  src="/hero.png" 
  alt="Hero" 
  width={800} 
  height={600} 
  priority  // For above-the-fold
/>
```

## SEO & Metadata

```typescript
export const metadata: Metadata = {
  title: 'Dashboard',
  description: 'User dashboard',
  openGraph: {
    title: 'Dashboard',
    description: 'User dashboard',
  },
};
```

## Performance Quick Wins

```typescript
// Dynamic import for heavy components
const HeavyChart = dynamic(() => import('./heavy-chart'), {
  loading: () => <ChartSkeleton />,
});

// Memoize expensive components
const ExpensiveList = React.memo(function ExpensiveList({ items }) {
  return items.map(item => <Item key={item.id} {...item} />);
});

// Stable callbacks
const handleClick = useCallback((id: string) => {
  setSelected(id);
}, []);
```

## Common Pitfalls Checklist

- [ ] No unnecessary `'use client'` directives
- [ ] Client boundaries pushed down the tree
- [ ] Data fetched in Server Components
- [ ] Suspense boundaries for slow data
- [ ] All Server Actions validate input
- [ ] Auth checked in Server Actions
- [ ] Using `<Link>` not `router.push` for nav
- [ ] Using `<Image>` not `<img>`
